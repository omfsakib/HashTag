<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>H A S H T A G</title>

    {% include 'components/links.html' %}

</head>
<body>
    <div class="wrapper">

        {% include 'components/header.html' %}
                                    
        {% block content %}
        {% endblock %}

        {% include 'components/footer.html' %}
        <script type="text/javascript">
            var updateBtns = document.getElementsByClassName('update-cart')
            
            
            
            for(var i = 0; i < updateBtns.length; i++){
            updateBtns[i].addEventListener('click',function(){
                var productID = this.dataset.product
                var action = this.dataset.action
                var color = this.dataset.color
                if (color == undefined){
                    color = "undefined"
                }
                var size = this.dataset.size
                console.log(size)
                if (size == undefined){
                    size = "undefined"
                }
                console.log('productID:',productID,'action:',action,'color:',color,'size:',size)
            
                console.log('USER:',user)
                if(user == 'AnonymousUser'){
                addCookieItem(productID, action, color, size)
                }else{
                updateUserOrder(productID, action, color, size )
                }
            })
            }
        
            function addCookieItem(productID, action,color, size){
                console.log('User id not authenticated')
                
                if (action == 'add'){
                    if(cart[productID] == undefined){
                        cart[productID] = {'quantity':1,'size':size ,'color':color}
                    }else{
                        cart[productID]['quantity'] += 1
                    }
                }
                if(action == 'remove') {
                    cart[productID]['quantity'] -= 1
                    
                    if(cart[productID]['quantity'] <= 0){
                        delete cart[productID]
                    }
                }
                if(action == 'delete') {
                    delete cart[productID]
                }
                if(action == 'color') {
                    cart[productID]['color'] = color
                }
                if(action == 'size') {
                    cart[productID]['size'] = size
                }
                console.log(cart)
                document.cookie = 'cart=' + JSON.stringify(cart) + ";doamin=;path=/"
                location.reload()
            }
            
            function updateUserOrder(productID, action, color, size){
            console.log('User is logged in, sending data...')
            
            var url = '/update_item/'
            const request = new Request(
                url,
                {headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken}}
            );
            fetch(request, {
                method:'POST',
                body:JSON.stringify({'productID':productID,'action':action,'color':color,'size':size,})
            })
            
            .then((response) =>{
                return response.json()
            })
            
            .then((data) =>{
                console.log('data:',data)
                location.reload()
            })
            }
        </script>
</body>
</html>